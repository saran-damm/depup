name: Upload Python Package

on:
  push:
    tags:
      - 'v*'

permissions:
  id-token: write       # required for PyPI trusted publishing
  contents: write       # required to push version update commit

jobs:
  publish:
    name: Build & Publish to PyPI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # allow commit back to main

      - name: Parse version from tag
        id: version
        run: |
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Parsed version: $VERSION"
      
      - name: Switch to main branch
        run: |
          git fetch origin main
          git checkout main
          git pull

      - name: Update version in pyproject.toml
        run: |
          sed -i "s/^version = .*/version = \"${{ steps.version.outputs.version }}\"/" pyproject.toml
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add pyproject.toml
          git commit -m "chore(release): set version ${{ steps.version.outputs.version }} [skip ci]"
          git push origin main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        run: |
          pip install uv
          uv pip install --system build

      - name: Build distributions
        run: uv build

      - name: Upload distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
